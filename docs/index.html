<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2022-09-19 Mon 13:59 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ReMASTER Documentation</title>
<meta name="author" content="Tim Vaughan" />
<meta name="generator" content="Org Mode" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="katex/katex.css" />
<script defer type="text/javascript" src="katex/katex.js"></script>
<script defer type="text/javascript" src="katex/contrib/auto-render.js"></script>
<script> document.addEventListener("DOMContentLoaded", function() {renderMathInElement(document.body, {delimiters: [{left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}, {left: '\\(', right: '\\)', display: false}, {left: '\\[', right: '\\]', display: true}], throwOnError : false});}); </script>
<style type="text/css">
html,button,input,select,textarea {  color: #484C66;}html {  font-size: 90%;  line-height: 1.4;}*,*:before,*:after {  -moz-box-sizing: border-box;  -webkit-box-sizing: border-box;  box-sizing: border-box;}a {  white-space: pre;  white-space: pre-wrap;  white-space: pre-line;  white-space: -pre-wrap;  white-space: -o-pre-wrap;  white-space: -moz-pre-wrap;  white-space: -hp-pre-wrap;  word-wrap: break-word;  text-decoration: none;}a:hover {  color: #0A4C89;}/* * Remove text-shadow in selection highlight: h5bp.com/i * These selection rule sets have to be separate. * Customize the background color to match your design. */::-moz-selection {  background: #0A4C89;  color: #FFF;  text-shadow: none;}::selection {  background: #0A4C89;  color: #FFF;  text-shadow: none;}/* * A better looking default horizontal rule */hr {  display: block;  height: 1px;  border: 0;  border-top: 1px dashed #CCC;  margin: 1em 0;  padding: 0;}/* * Remove the gap between images, videos, audio and canvas and the bottom of * their containers: h5bp.com/i/440 */audio,canvas,img,video {  vertical-align: middle;}/* * Remove default fieldset styles. */fieldset {  border: 0;  margin: 0;  padding: 0;}/* * Allow only vertical resizing of textareas. */textarea {  resize: vertical;}/* ==========================================================================   Author's custom styles   ========================================================================== */.todo,.done,.tag {  font-family: "Source Pro", Monaco, "Courier New", monospace;  padding: 0 0.3em;  background-color: #EEE;  border: 1px solid #CCC;}.todo {  color: #DD4433;}.done {  color: #44934B;}.tag {  font-size: 80%;  font-weight: normal;  margin: 0 0.3em;  display: none;}.timestamp {  color: #BEBEBE;}.timestamp-kwd {  color: #5F9EA0;}.right {  margin-left: auto;  margin-right: 0px;  text-align: right;}.left {  margin-left: 0px;  margin-right: auto;  text-align: left;}.center {  margin-left: auto;  margin-right: auto;  text-align: center;}.underline {  text-decoration: underline;}#postamble p,#preamble p {  font-size: 90%;  margin: .2em;}pre,code {  font-family: "Source Pro", Monaco, "Courier New", monospace;  padding-left: 0.3em;  padding-right: 0.3em;}pre {  font-size: 90%;  padding: 8pt;  overflow: auto;  white-space: pre;  word-wrap: normal;}pre.src {  position: relative;}pre.src:before {  display: none;  position: absolute;  background-color: #FFF;  top: 0.5em;  right: 0.5em;  padding: 4px;  border: 1px solid #CCC;}pre.src-sh:before {  content: "Shell Script";}pre.src-bash:before {  content: "Bash Script";}pre.src-emacs-lisp:before {  content: "Emacs Lisp";}pre.src-R:before {  content: "R";}pre.src-perl:before {  content: "Perl";}pre.src-java:before {  content: "Java";}pre.src-sql:before {  content: "SQL";}pre.src-c:before {  content: "C";}pre.src-cpp:before {  content: "C++";}pre.src-html:before {  content: "HTML";}table {  border-collapse: collapse;  display: block;  overflow-x: auto;}caption.t-above {  caption-side: top;}caption.t-bottom {  caption-side: bottom;}td, th {  vertical-align: top;  border: 1px solid #CCC;  padding: 0.5em;}th.right {  text-align: center;}th.left {  text-align: center;}th.center {  text-align: center;}td.right {  text-align: right;}td.left {  text-align: left;}td.center {  text-align: center;}dt {  font-weight: bold;}#footnotes {  border-top: 5px solid #0A4C89;  margin-bottom: 5em;}#footnotes h2 {  display: none;}#text-footnotes {  margin-top: 1em;}.footpara:nth-child(2) {  display: inline;}.footpara {  display: block;}.footdef sup:before {  content: "[";}.footdef sup:after {  content: "]";}.footdef p {  display: inline;}figure {  margin: 0;}figure img {  max-width: 100%;}figcaption {  text-align: center;  font-size: 0.8rem;}.inlinetask {  padding: 10px;  border: 2px solid gray;  margin: 10px;  background: #ffffcc;}#org-div-home-and-up {  text-align: right;  font-size: 70%;  white-space: nowrap;}textarea {  overflow-x: auto;}.linenr {  font-size: smaller;}.code-highlighted {  background-color: #ffff00;}.org-info-js_info-navigation {  border-style: none;}#org-info-js_console-label {  font-size: 10px;  font-weight: bold;  white-space: nowrap;}.org-info-js_search-highlight {  background-color: #ffff00;  color: #000000;  font-weight: bold;}p.verse,blockquote {  margin: 0;  padding: 0;  padding-left: 3%;  border-left: 5px solid #0A4C89;}body {  font-family: Lora, Palatino, Georgia, serif;  width: 92%;  max-width: 50em;  margin: 0 auto;  background-color: #FFF;}h2 {  line-height: 1.62em;}.title {  margin: 0 0 2em 0;  line-height: 2em;  border-bottom: 5px solid #0A4C89;  text-align: center;}#postamble {  font-size: 80%;  line-height: 1.4em;  text-align: right;}h1, h2, h3, h4, h5, h6 {  font-family: "Source Sans Pro", sans-serif;  color: #222;}.outline-2 {  margin-bottom: 4em;}.outline-2 h2 {  border-bottom: 1px solid #CCC;}.outline-text-2 code, pre {  background-color: #EEE;}#table-of-contents {  display: none;  margin-left: 0.5em;}#text-table-of-contents ul {  padding-left: 1.8em;}#text-table-of-contents li {  list-style-type: circle;  margin: 0.4em 0;}#text-table-of-contents ul ul {  margin: 0;}#text-table-of-contents li li {  font-weight: normal;  font-size: 90%;  margin: 0;}#content {  overflow: hidden;  *zoom: 1;}/* ==========================================================================   EXAMPLE Media Queries for Responsive Design.   These examples override the primary ('mobile first') styles.   Modify as content requires.   ========================================================================== */@media only screen and (min-width: 35em) {  /* Style adjustments for viewports that meet the condition */}@media print, (-o-min-device-pixel-ratio: 5 / 4), (-webkit-min-device-pixel-ratio: 1.25), (min-resolution: 120dpi) {  /* Style adjustments for high resolution devices */}/* ==========================================================================   Print styles.   Inlined to avoid required HTTP connection: h5bp.com/r   ========================================================================== */@media print {  * {    background: transparent !important;    color: #000 !important;    /* Black prints faster: h5bp.com/s */    box-shadow: none !important;    text-shadow: none !important;  }  a,  a:visited {    text-decoration: underline;  }  a[href]:after {    content: " (" attr(href) ")";  }  abbr[title]:after {    content: " (" attr(title) ")";  }  /*   * Don't show links for images, or javascript/internal links   */  .ir a:after,  a[href^="javascript:"]:after,  a[href^="#"]:after {    content: "";  }  pre,  blockquote {    /* border: 1px solid #999; */    page-break-inside: avoid;  }  thead {    display: table-header-group;    /* h5bp.com/t */  }  tr,  img {    page-break-inside: avoid;  }  img {    max-width: 100% !important;  }  @page {    margin: 0.5cm;  }  p,  h2,  h3 {    orphans: 3;    widows: 3;  }  h2,  h3 {    page-break-after: avoid;  }  #table-of-contents {    display: block;    width: initial;    border: none;  }  #table-of-contents a {    text-decoration: none;  }}/* large screen */@media screen and (min-width: 40rem) {  html {    font-size: 100%;  }  #table-of-contents {    display: block;    padding: 1em;    width: 32%;    min-width: 18em;    float: right;    background-color: #EEE;    position: relative;    /* required by z-index */    z-index: 5000;    border: 1px solid #CCC;  }  .tag {    display: initial;  }}
</style>
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">ReMASTER Documentation</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgccdd327">1. Overview</a>
<ul>
<li><a href="#org7cbc87a">1.1. The name</a></li>
<li><a href="#org1444685">1.2. License</a></li>
</ul>
</li>
<li><a href="#orgf5ad7e7">2. Installation</a></li>
<li><a href="#org1e5e18d">3. Model specification</a>
<ul>
<li><a href="#orgbac44f2">3.1. Populations</a></li>
<li><a href="#org75d807c">3.2. Reactions</a>
<ul>
<li><a href="#orgaf5f4da">3.2.1. Continuous reactions</a></li>
<li><a href="#org54278c0">3.2.2. Punctual reactions</a></li>
<li><a href="#orgac4230b">3.2.3. Identifying parents and children</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org587f397">4. Trajectory simulation</a>
<ul>
<li><a href="#org2258d18">4.1. Stochastic Trajectories</a></li>
<li><a href="#orgecb1b22">4.2. Deterministic Trajectories</a></li>
<li><a href="#org490aefe">4.3. Placing conditions on trajectories</a></li>
<li><a href="#org4e3d8f9">4.4. Self-contained trajectory simulation XMLs</a></li>
<li><a href="#orgdf192b3">4.5. Plotting simulated trajectories</a></li>
</ul>
</li>
<li><a href="#org16deedf">5. Tree simulation</a>
<ul>
<li><a href="#orgb8d3d86">5.1. Self-contained tree simulation XMLs</a></li>
<li><a href="#org7ce50a0">5.2. Logging typed trees</a></li>
<li><a href="#orgca654b9">5.3. Logging untyped trees</a></li>
</ul>
</li>
<li><a href="#orgcbe2b9b">6. Integrating with BEAST</a></li>
<li><a href="#org068cfc9">7. Examples</a></li>
<li><a href="#orgf953a7e">8. Appendix</a>
<ul>
<li><a href="#org47608ae">8.1. Condition syntax</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<p>
<b><b>Warning: Remaster is still in development and not yet suitable for production use.</b></b>
</p>

<p>
GitHub Repository: <a href="https://github.com/tgvaughan/remaster">https://github.com/tgvaughan/remaster</a>
</p>

<div id="outline-container-orgccdd327" class="outline-2">
<h2 id="orgccdd327"><span class="section-number-2">1.</span> Overview</h2>
<div class="outline-text-2" id="text-1">
<p>
ReMASTER is a flexible tool for simulating trajectories
and trees from birth-death and coalescent models commonly used in
phylodynamic inference, as well as some less common models.
</p>

<p>
ReMASTER defines stochastic population models using an intuitive
"reaction" notation borrowed from Chemistry.  Using this notation,
a simple birth-death process on the number of individuals of type $X$
might be expressed using the following pair of reactions:
$$X \overset{\lambda}{\longrightarrow} 2X$$
and
$$X \overset{\mu}{\longrightarrow} 0$$
where in each case the elements on the left-hand side of the arrow
indicate the individual(s) involved in the reaction (the reactants),
and the elements on the right-hand side correspond to the individual(s)
remaining after the reaction has fired.  The symbol above the arrow
represents the rate (probability per unit time) at which the reaction
fires for each available combination of reactants.
</p>

<p>
In order to permit the simulation of reconstructed phylogenies corresponding
to subsets of the whole population, ReMASTER allows users to specify that
one or more of the model populations are "sample" populations.  This means
that sampling processes can be explicitly included in the simulation model.
For instance, by adding the reaction
$$ X \overset{\psi}{\longrightarrow} S$$
where $S$ is defined as a sample population, the birth-death model above becomes the
linear birth-death-sampling model which is the basis of much modern phylodynamic inference.
</p>

<p>
In addition, ReMASTER allows one to define "punctual" reactions which occur
at pre-determined times and fire a fixed or stochastic number of times.
Besides allowing models to include interesting discrete events, this allows
users to pre-specify sample counts and times.
</p>

<p>
Setting up a model in master involves composing an XML input file
describing initial population sizes and the set of reactions governing
their dynamics.  The input file format is quite readable and concise.
For example, the following is a complete XML input file for 
simulating 100 trees under a the above birth-death sampling model with
$\lambda=2$, $\mu=1$ and $\psi=0.1$:
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #ff1493;">beast</span> <span style="color: #ff69b4;">version</span>=<span style="color: #61CE3C;">"2.0"</span> <span style="color: #ff69b4;">namespace</span>=<span style="color: #61CE3C;">"beast.core.parameter:beast.core:remaster"</span>&gt;
    &lt;<span style="color: #ff1493;">run</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"Simulator"</span> <span style="color: #ff69b4;">nSims</span>=<span style="color: #61CE3C;">"100"</span>&gt;
        &lt;<span style="color: #ff1493;">simulate</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"SimulatedTree"</span> <span style="color: #ff69b4;">id</span>=<span style="color: #61CE3C;">"tree"</span>&gt;
            &lt;<span style="color: #ff1493;">trajectory</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"StochasticTrajectory"</span> <span style="color: #ff69b4;">id</span>=<span style="color: #61CE3C;">"SIRTrajectory"</span> <span style="color: #ff69b4;">endsWhen</span>=<span style="color: #61CE3C;">"sample&gt;=10"</span>&gt;
                &lt;<span style="color: #ff1493;">population</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"RealParameter"</span> <span style="color: #ff69b4;">id</span>=<span style="color: #61CE3C;">"X"</span> <span style="color: #ff69b4;">value</span>=<span style="color: #61CE3C;">"1"</span>/&gt;
                &lt;<span style="color: #ff1493;">samplePopulation</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"RealParameter"</span> <span style="color: #ff69b4;">id</span>=<span style="color: #61CE3C;">"S"</span> <span style="color: #ff69b4;">value</span>=<span style="color: #61CE3C;">"0"</span>/&gt;

                &lt;<span style="color: #ff1493;">reaction</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"Reaction"</span> <span style="color: #ff69b4;">rate</span>=<span style="color: #61CE3C;">"2"</span>&gt; X -&gt; 2X &lt;/<span style="color: #ff1493;">reaction</span>&gt;
                &lt;<span style="color: #ff1493;">reaction</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"Reaction"</span> <span style="color: #ff69b4;">rate</span>=<span style="color: #61CE3C;">"1"</span>&gt; X -&gt; 0 &lt;/<span style="color: #ff1493;">reaction</span>&gt;
                &lt;<span style="color: #ff1493;">reaction</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"Reaction"</span> <span style="color: #ff69b4;">rate</span>=<span style="color: #61CE3C;">"0.1"</span>&gt; X -&gt; S &lt;/<span style="color: #ff1493;">reaction</span>&gt;
            &lt;/<span style="color: #ff1493;">trajectory</span>&gt;
        &lt;/<span style="color: #ff1493;">simulate</span>&gt;

        &lt;<span style="color: #ff1493;">logger</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"Logger"</span> <span style="color: #ff69b4;">fileName</span>=<span style="color: #61CE3C;">"simulated.trees"</span>&gt;
            &lt;<span style="color: #ff1493;">log</span> <span style="color: #ff69b4;">idref</span>=<span style="color: #61CE3C;">"tree"</span>/&gt;
        &lt;/<span style="color: #ff1493;">logger</span>&gt;
    &lt;/<span style="color: #ff1493;">run</span>&gt;
&lt;/<span style="color: #ff1493;">beast</span>&gt;
</pre>
</div>

<p>
ReMASTER is a <a href="https://www.beast2.org/">BEAST 2</a> package, and integrates well with that platform.
Simulated ReMASTER trees can be used directly inside of regular BEAST
XML analysis scripts to initialise MCMC states or construct
simulation-based validation studies.
</p>
</div>

<div id="outline-container-org7cbc87a" class="outline-3">
<h3 id="org7cbc87a"><span class="section-number-3">1.1.</span> The name</h3>
<div class="outline-text-3" id="text-1-1">
<p>
"ReMASTER" is a play on the name of an earlier simulation tool, <a href="https://tgvaughan.github.io/MASTER">MASTER</a>.
ReMASTER is a new implementation which is faster, leaner, and more capable
of performing the simulation tasks for which MASTER itself is actually used.
</p>
</div>
</div>

<div id="outline-container-org1444685" class="outline-3">
<h3 id="org1444685"><span class="section-number-3">1.2.</span> License</h3>
<div class="outline-text-3" id="text-1-2">
<p>
ReMASTER is free software, and is made available under the terms of
version 3 of the GNU General Public License, the text of which is
available <a href="https://raw.githubusercontent.com/tgvaughan/remaster/master/COPYING">here</a>.  The source code for the project can be found at the
official Github project page: <a href="https://github.com/tgvaughan/remaster">https://github.com/tgvaughan/remaster</a>.
</p>
</div>
</div>
</div>

<div id="outline-container-orgf5ad7e7" class="outline-2">
<h2 id="orgf5ad7e7"><span class="section-number-2">2.</span> Installation</h2>
<div class="outline-text-2" id="text-2">
<p>
ReMASTER is a BEAST 2 package and will eventually be available for installation
directly from the standard BEAST 2 package repository.  However, while it is still
in development, installation must be done as follows:
</p>

<ol class="org-ol">
<li>Open BEAUti,</li>
<li>Open the <code>File</code> menu and select <code>Manage packages</code>.</li>
<li>Press the <code>Package repositories</code> button at the bottom of the dialog box, then add the
following URL: <a href="https://tgvaughan.github.io/remaster/package.xml">https://tgvaughan.github.io/remaster/package.xml</a></li>
<li>Press <code>Done</code> to return to the package list.</li>
<li>Select "remaster" from the package list and press the <code>Install/Upgrade</code> button.</li>
</ol>

<p>
ReMASTER should now be available on your system, and running beast
with a ReMASTER input file should perform the corresponding
simulation.
</p>
</div>
</div>

<div id="outline-container-org1e5e18d" class="outline-2">
<h2 id="org1e5e18d"><span class="section-number-2">3.</span> Model specification</h2>
<div class="outline-text-2" id="text-3">
<p>
Like MASTER, ReMASTER defines models in terms of <a href="#orgbac44f2">populations</a> and <a href="#org75d807c">reactions</a>.
</p>
</div>

<div id="outline-container-orgbac44f2" class="outline-3">
<h3 id="orgbac44f2"><span class="section-number-3">3.1.</span> Populations</h3>
<div class="outline-text-3" id="text-3-1">
<p>
A population in ReMASTER is simply a <code>RealParameter</code> (or other
<code>Function</code>) with a specific ID.  The value of the <code>RealParameter</code> is
used as its initial population size in the simulation.
</p>

<p>
For example, the following defines a population named "X" with an initial size
of 10:
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #ff1493;">population</span> <span style="color: #ff69b4;">id</span>=<span style="color: #61CE3C;">"X"</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"RealParameter"</span> <span style="color: #ff69b4;">value</span>=<span style="color: #61CE3C;">"10"</span>/&gt;
</pre>
</div>

<p>
If the <code>RealParameter</code> is a vector, its elements represent subpopulations.
For example, the following population "Y" has two subpopulations initially
occupied by 1 and 10 individuals, respectively:
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #ff1493;">population</span> <span style="color: #ff69b4;">id</span>=<span style="color: #61CE3C;">"Y"</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"RealParameter"</span> <span style="color: #ff69b4;">value</span>=<span style="color: #61CE3C;">"1 10"</span>/&gt;
</pre>
</div>

<p>
Populations may also be marked as "sample" populations by using the appropriate
tag:
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #ff1493;">samplePopulation</span> <span style="color: #ff69b4;">id</span>=<span style="color: #61CE3C;">"sample"</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"RealParameter"</span> <span style="color: #ff69b4;">value</span>=<span style="color: #61CE3C;">"0"</span>/&gt;
</pre>
</div>
<p>
For trajectories, sample populations behave just like any other
population, besides being forbidden from appearing on the reactant
side of a reaction.  individuals of these populations take on a
special meaning when trees are simulated, however, as the production
of a sample corresponds to the creation of a node (internal or
external) in the resulting tree.
</p>
</div>
</div>

<div id="outline-container-org75d807c" class="outline-3">
<h3 id="org75d807c"><span class="section-number-3">3.2.</span> Reactions</h3>
<div class="outline-text-3" id="text-3-2">
<p>
Reactions connect zero or more <b>reactant</b> individuals with zero or
more <b>product</b> individuals.  The dynamics that ReMASTER simulates are
simply the result of applying reactions at random or pre-determined times.
</p>

<p>
There are two distinct kinds of reactions which can be specified: "continuous"
reactions and "punctual" reactions.
</p>
</div>


<div id="outline-container-orgaf5f4da" class="outline-4">
<h4 id="orgaf5f4da"><span class="section-number-4">3.2.1.</span> Continuous reactions</h4>
<div class="outline-text-4" id="text-3-2-1">
<p>
As the name suggests, reactions are applied continuously throughout the
simulation at particular <i>rates</i> which determine the probability per
unit time for the reaction firing on each of the possible combinations
of reactant individuals.
</p>

<p>
Use the following notation to specify a continuous reaction with a fixed rate in the XML:
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #ff1493;">reaction</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"Reaction"</span> <span style="color: #ff69b4;">rate</span>=<span style="color: #61CE3C;">"2"</span>&gt; S + I -&gt; 2I &lt;/<span style="color: #ff1493;">reaction</span>&gt;
</pre>
</div>

<p>
The rate of a continuous reaction can change at one or more times.  For example,
to specify that the rate should change from 2 to 1.4 at time 4, you can write
the following:
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #ff1493;">reaction</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"Reaction"</span> <span style="color: #ff69b4;">rate</span>=<span style="color: #61CE3C;">"2 1"</span> <span style="color: #ff69b4;">changeTime</span>=<span style="color: #61CE3C;">"4"</span>&gt; S + I -&gt; 2I &lt;/<span style="color: #ff1493;">reaction</span>&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org54278c0" class="outline-4">
<h4 id="org54278c0"><span class="section-number-4">3.2.2.</span> Punctual reactions</h4>
<div class="outline-text-4" id="text-3-2-2">
<p>
In contrast, punctual reactions are applied at one or more pre-defined
<i>times</i>. At each of thes times, a punctual reaction may be applied
with some probability to each available combination of reactants
(i.e. the number of times the reaction fires is still random) or it
may be applied a pre-specified number of times.
</p>

<p>
To specify a punctual reaction which fires with a particular probability
for each available reactant (here 0.5) and at a chosen time (here 10),
use the following notation:
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #ff1493;">reaction</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"PunctualReaction"</span> <span style="color: #ff69b4;">p</span>=<span style="color: #61CE3C;">"0.5"</span> <span style="color: #ff69b4;">time</span>=<span style="color: #61CE3C;">"10"</span>&gt; I -&gt; sample &lt;/<span style="color: #ff1493;">reaction</span>&gt;
</pre>
</div>

<p>
To instead configure the reaction to fire a fixed number of times (say
5), replace the <code>p</code> attribute with a <code>n</code> attribute specifying the
number:
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #ff1493;">reaction</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"PunctualReaction"</span> <span style="color: #ff69b4;">n</span>=<span style="color: #61CE3C;">"5"</span> <span style="color: #ff69b4;">time</span>=<span style="color: #61CE3C;">"10"</span>&gt; I -&gt; sample &lt;/<span style="color: #ff1493;">reaction</span>&gt;
</pre>
</div>

<p>
Each of <code>p</code>, <code>n</code> and <code>time</code> can take more than one value. For instance,
to specify that the sampling reaction should fire 5 times at time 1.0,
7 times at time 2.0 and 10 times at time 5.0, one could write
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #ff1493;">reaction</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"PunctualReaction"</span> <span style="color: #ff69b4;">n</span>=<span style="color: #61CE3C;">"5 7 10"</span> <span style="color: #ff69b4;">time</span>=<span style="color: #61CE3C;">"1.0 2.0 5.0"</span>&gt; I -&gt; sample &lt;/<span style="color: #ff1493;">reaction</span>&gt;
</pre>
</div>

<p>
In the case that the number of elements provided to <code>n</code> or <code>p</code> and the
number provided to <code>time</code> do not match, elements of the shorter vector
are reused.  Thus one could specify multiple $&rho;$-sampling events
each with the same sampling probability of $\rho=0.5$ by writing
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #ff1493;">reaction</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"PunctualReaction"</span> <span style="color: #ff69b4;">p</span>=<span style="color: #61CE3C;">"0.5"</span> <span style="color: #ff69b4;">time</span>=<span style="color: #61CE3C;">"1.0 2.0 5.0"</span>&gt; I -&gt; sample &lt;/<span style="color: #ff1493;">reaction</span>&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgac4230b" class="outline-4">
<h4 id="orgac4230b"><span class="section-number-4">3.2.3.</span> Identifying parents and children</h4>
<div class="outline-text-4" id="text-3-2-3">
<p>
Although the reaction notation is intuitive, on its own it does not
specify the parent/child relationships between reactants and products.
For example, consider the following reaction representing pathogen
transmission in an SIR model:
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #ff1493;">reaction</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"Reaction"</span> <span style="color: #ff69b4;">rate</span>=<span style="color: #61CE3C;">"0.1"</span>&gt; S + I -&gt; 2I &lt;/<span style="color: #ff1493;">reaction</span>&gt;
</pre>
</div>

<p>
The only thing which can be determined from this reaction is that one $S$
and one $I$ individual are replaced by a pair of $I$ individuals.  It is
completely unclear whether either of the $S$ or $I$ reactants should be
regarded as a parent of any of the products.
</p>

<p>
Specifying these relationships is necessary in order for trees composed
of ancestral lineages can be built.
</p>

<p>
There are two main ways to work around this limitation.  Firstly, one can
rely on ReMASTER to automatically associate parents with children.
By default, ReMASTER assumes that a product individual is considered to
be
</p>
<ol class="org-ol">
<li>the child of the first reactant having the same population type, if one exists, or</li>
<li>the child the first reactant listed, if one exists, or</li>
<li>an orphan.</li>
</ol>

<p>
These rules mean that, in the SIR reaction above, the two $I$ product individuals
would be regarded as children of the $I$ reactant, and that the $S$ would have no
children.
</p>

<p>
Alternatively, ReMASTER lets you explicitly specify parent-child relationships
by appending ":label" tags to reaction elements identifying them as belonging
to the same family.  If, for instance, we wanted the $S$ reactant to be the parent
of the two $I$ products, we could write
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #ff1493;">reaction</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"Reaction"</span> <span style="color: #ff69b4;">rate</span>=<span style="color: #61CE3C;">"0.1"</span>&gt; S:a + I:b -&gt; 2I:a &lt;/<span style="color: #ff1493;">reaction</span>&gt;
</pre>
</div>

<p>
Note that unlike MASTER, ReMASTER requires each child have at most one parent, ensuring
that the resulting relationships are tree-like.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org587f397" class="outline-2">
<h2 id="org587f397"><span class="section-number-2">4.</span> Trajectory simulation</h2>
<div class="outline-text-2" id="text-4">
<p>
Trajectories are simply realisations of the population process.  There are two
distinct types of trajectories in ReMASTER: <b>stochastic trajectories</b> and <b>deterministic trajectories</b>.
</p>

<p>
Stochastic trajectories are simulated using a standard Gillespie-style
algorithm, and are exact realisations of the continuous-time
discrete-state Markov process defined by the reactions.  These are the
trajectories that you'll want to use to simulate trees under
birth-death phylodynamic models.
</p>

<p>
Deterministic trajectories are simulated by integrating a set of
ordinary differential equations corresponding to the reactions.  The
dynamics generated are essentially the limiting behaviour of the
stochastic trajectories when the population sizes are very large and
the relative impact of the demographic stochasticity becomes
vanishingly small.  These are the trajectories you'll want to use to
simulate trees under coalescent models or coalescent approximations of
birth-death models.
</p>
</div>

<div id="outline-container-org2258d18" class="outline-3">
<h3 id="org2258d18"><span class="section-number-3">4.1.</span> Stochastic Trajectories</h3>
<div class="outline-text-3" id="text-4-1">
<p>
Once the population and reaction elements are specified, defining a
stochastic trajectory in ReMASTER's XML is very easy.
</p>

<p>
For example, the following represents a stochastic
birth-death-sampling process trajectory with constant rates:
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #ff1493;">trajectory</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"StochasticTrajectory"</span>
            <span style="color: #ff69b4;">maxTime</span>=<span style="color: #61CE3C;">"10"</span>&gt;
  &lt;<span style="color: #ff1493;">population</span> <span style="color: #ff69b4;">id</span>=<span style="color: #61CE3C;">"X"</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"RealParameter"</span> <span style="color: #ff69b4;">value</span>=<span style="color: #61CE3C;">"1"</span>/&gt;

  &lt;<span style="color: #ff1493;">reaction</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"Reaction"</span> <span style="color: #ff69b4;">rate</span>=<span style="color: #61CE3C;">"1.2"</span>&gt; X -&gt; 2X &lt;/<span style="color: #ff1493;">reaction</span>&gt;
  &lt;<span style="color: #ff1493;">reaction</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"Reaction"</span> <span style="color: #ff69b4;">rate</span>=<span style="color: #61CE3C;">"1"</span>&gt; X -&gt; 0 &lt;/<span style="color: #ff1493;">reaction</span>&gt;
&lt;/<span style="color: #ff1493;">trajectory</span>&gt;
</pre>
</div>

<p>
The <code>maxTime</code> attribute specifies the maximum end time of the
simulation.  For stochastic trajectories this attribute is actually
optional, since there are many birth-death processes (although not
this one) are guaranteed to terminate in finite amount of time.
(ReMASTER always ceases the simulation once no reactions are able to
fire.)
</p>
</div>
</div>

<div id="outline-container-orgecb1b22" class="outline-3">
<h3 id="orgecb1b22"><span class="section-number-3">4.2.</span> Deterministic Trajectories</h3>
<div class="outline-text-3" id="text-4-2">
<p>
Defining deterministic trajectories is almost exactly the same as defining
a stochastic trajectory.  The only difference is that the <code>spec</code> attribute
must be set to "DeterministicTrajectory" and the <code>maxTime</code> attribute is
mandatory.
</p>

<p>
For example, the following represents an exponentially growing population
with rate $\lamba-\mu=1.2-1.0=0.2$:
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #ff1493;">trajectory</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"DeterministicTrajectory"</span>
            <span style="color: #ff69b4;">maxTime</span>=<span style="color: #61CE3C;">"10"</span>&gt;
  &lt;<span style="color: #ff1493;">population</span> <span style="color: #ff69b4;">id</span>=<span style="color: #61CE3C;">"X"</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"RealParameter"</span> <span style="color: #ff69b4;">value</span>=<span style="color: #61CE3C;">"1"</span>/&gt;

  &lt;<span style="color: #ff1493;">reaction</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"Reaction"</span> <span style="color: #ff69b4;">rate</span>=<span style="color: #61CE3C;">"1.2"</span>&gt; X -&gt; 2X &lt;/<span style="color: #ff1493;">reaction</span>&gt;
  &lt;<span style="color: #ff1493;">reaction</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"Reaction"</span> <span style="color: #ff69b4;">rate</span>=<span style="color: #61CE3C;">"1"</span>&gt; X -&gt; 0 &lt;/<span style="color: #ff1493;">reaction</span>&gt;
&lt;/<span style="color: #ff1493;">trajectory</span>&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org490aefe" class="outline-3">
<h3 id="org490aefe"><span class="section-number-3">4.3.</span> Placing conditions on trajectories</h3>
<div class="outline-text-3" id="text-4-3">
<p>
In addition to the rates and initial population sizes, conditions can
be placed on trajectory outcomes so that the simulation finishes
when the population sizes reach some specified target or, in the case
of stochastic trajectories, the resulting trajectory is only "accepted"
when a particular condition is met.
</p>

<p>
To define an early termination point, provide the <code>endsWhen</code> attribute
to the trajectory element.  The value of the attribute should be a
predicating which will cause the simulation to end when it becomes true.
For instance
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #ff1493;">trajectory</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"StochasticTrajectory"</span>
            <span style="color: #ff69b4;">endsWhen</span>=<span style="color: #61CE3C;">"X=100"</span>&gt;
...
&lt;/<span style="color: #ff1493;">trajectory</span>&gt;
</pre>
</div>
<p>
defines a trajectory whose simulation will be terminated the instant that
the $X$ population contains exactly 100 individuals.
</p>

<p>
Similarly, to define a condition on the finished simulation, use the
<code>mustHave</code> attribute. For instance,
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #ff1493;">trajectory</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"StochasticTrajectory"</span>
            <span style="color: #ff69b4;">mustHave</span>=<span style="color: #61CE3C;">"sample&lt;</span><span style="color: #61CE3C;">=50"</span>&gt;
...
&lt;/<span style="color: #ff1493;">trajectory</span>&gt;
</pre>
</div>
<p>
specifies that the  "sample" population must contain at most 50 individuals
at the end of the simulation.
</p>

<p>
The complete syntax for these predicates is specified in section <a href="#org47608ae">8.1</a>.
</p>
</div>
</div>

<div id="outline-container-org4e3d8f9" class="outline-3">
<h3 id="org4e3d8f9"><span class="section-number-3">4.4.</span> Self-contained trajectory simulation XMLs</h3>
<div class="outline-text-3" id="text-4-4">
<p>
While the above XML fragments are sufficient to represent a simulated trajectory, in order to actually be useful
it needs to be embedded in a BEAST XML that produces output.  The most direct way to do this is via
ReMASTER's <code>Simulator</code> object, which can be used as a <code>&lt;run&gt;</code> element as follows:
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #ff1493;">beast</span> <span style="color: #ff69b4;">version</span>=<span style="color: #61CE3C;">"2.0"</span> <span style="color: #ff69b4;">namespace</span>=<span style="color: #61CE3C;">"beast.core.parameter:remaster"</span>&gt;
  &lt;<span style="color: #ff1493;">run</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"Simulator"</span> <span style="color: #ff69b4;">nSims</span>=<span style="color: #61CE3C;">"100"</span>&gt;
    &lt;<span style="color: #ff1493;">simulate</span> <span style="color: #ff69b4;">id</span>=<span style="color: #61CE3C;">"trajectory"</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"StochasticTrajectory"</span> <span style="color: #ff69b4;">maxTime</span>=<span style="color: #61CE3C;">"10"</span>&gt;
      &lt;<span style="color: #ff1493;">population</span> <span style="color: #ff69b4;">id</span>=<span style="color: #61CE3C;">"X"</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"RealParameter"</span> <span style="color: #ff69b4;">value</span>=<span style="color: #61CE3C;">"1"</span>/&gt;
      &lt;<span style="color: #ff1493;">reaction</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"Reaction"</span> <span style="color: #ff69b4;">rate</span>=<span style="color: #61CE3C;">"1.2"</span>&gt; X -&gt; 2X &lt;/<span style="color: #ff1493;">reaction</span>&gt;
      &lt;<span style="color: #ff1493;">reaction</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"Reaction"</span> <span style="color: #ff69b4;">rate</span>=<span style="color: #61CE3C;">"1"</span>&gt; X -&gt; 0 &lt;/<span style="color: #ff1493;">reaction</span>&gt;
    &lt;/<span style="color: #ff1493;">simulate</span>&gt;

    &lt;<span style="color: #ff1493;">logger</span> <span style="color: #ff69b4;">fileName</span>=<span style="color: #61CE3C;">"output.traj"</span>&gt;
      &lt;<span style="color: #ff1493;">log</span> <span style="color: #ff69b4;">idref</span>=<span style="color: #61CE3C;">"trajectory"</span>/&gt;
    &lt;/<span style="color: #ff1493;">logger</span>&gt;
  &lt;/<span style="color: #ff1493;">run</span>&gt;
&lt;/<span style="color: #ff1493;">beast</span>&gt;
</pre>
</div>

<p>
The <code>Simulator</code> takes the following inputs:
</p>
<dl class="org-dl">
<dt>nSims</dt><dd>an integer specifying the number of independent simulations to perform,</dd>
<dt>simulate</dt><dd>an object representing the simulation, in this case a <code>StochasticTrajectory</code>, and</dd>
<dt>logger</dt><dd>what to record in the output files for each replicate of the simulation.
This input can take multiple values, one for each output file.
(In this case we only produce one output file, containing a representation of the whole simulated trajectory.)</dd>
</dl>

<p>
To run the simulation and produce the output, copy the above XML into
a file named something like "BDtraj.xml" and then run it through BEAST:
</p>
<pre class="example" id="org15ecd28">
$ beast BDtraj.xml
</pre>

<p>
This should produce some screen output, together with a file
"output.traj" containing the simulated trajectories.
</p>
</div>
</div>

<div id="outline-container-orgdf192b3" class="outline-3">
<h3 id="orgdf192b3"><span class="section-number-3">4.5.</span> Plotting simulated trajectories</h3>
<div class="outline-text-3" id="text-4-5">
<p>
In order to actually visualize the simulation output, we can make use of the script
<a href="https://github.com/tgvaughan/remaster/blob/master/scripts/trajTools.R">trajTools.R</a> which one can find in the <code>scripts/</code> directory of the ReMASTER repository
to load the trajectories into a data frame:
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #96CBFE;">source</span>(<span style="color: #61CE3C;">"&lt;PATH&gt;/ReMASTER/scripts/trajTools.R"</span>)
traj <span style="color: #96CBFE;">&lt;-</span> loadTrajectories(<span style="color: #61CE3C;">"output.traj"</span>)
</pre>
</div>
<p>
(Here "&lt;PATH&gt;" is the path to the ReMASTER repository or package directory.)
</p>

<p>
The resulting data frame has the following layout:
</p>
<pre class="example" id="orge95c9c6">
&gt; traj
# A tibble: 8,039 × 5
        t population index value Sample
    &lt;dbl&gt; &lt;chr&gt;      &lt;dbl&gt; &lt;dbl&gt;  &lt;int&gt;
 1 0      X              0     1      0
 2 1.05   X              0     0      0
 3 0      X              0     1      1
 4 0.0269 X              0     2      1
 5 0.0484 X              0     3      1
 6 0.213  X              0     2      1
 7 0.990  X              0     1      1
 8 1.73   X              0     2      1
 9 1.80   X              0     3      1
10 1.95   X              0     4      1
# … with 8,029 more rows
</pre>
<p>
Each row specifies the size of a particular population (or
subpopulation) at a particular time.  The "Sample" indicies
indicate to which specific simulated trajectory the results belong.
</p>

<p>
This format is ideal for plotting using <a href="https://ggplot2.tidyverse.org">ggplot2</a>:
</p>
<div class="org-src-container">
<pre class="src src-R">ggplot(traj, aes(t, value, group_by=factor(traj))) + geom_step(alpha=0.5)
</pre>
</div>


<figure id="orgc667f03">
<img src="examples/BDtraj_output.png" alt="BDtraj_output.png">

</figure>
</div>
</div>
</div>

<div id="outline-container-org16deedf" class="outline-2">
<h2 id="org16deedf"><span class="section-number-2">5.</span> Tree simulation</h2>
<div class="outline-text-2" id="text-5">
<p>
Once a trajectory simulation is configured, producing the corresponding trees
is easy.  All that is required is to enclose the trajectory element
(<code>DeterministicTrajectory</code> or <code>StochasticTrajectory</code>) in a <code>SimulatedTree</code> element:
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #ff1493;">tree</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"SimulatedTree"</span>&gt;
  &lt;<span style="color: #ff1493;">trajectory</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"StochasticTrajectory"</span>
              <span style="color: #ff69b4;">maxTime</span>=<span style="color: #61CE3C;">"10"</span>&gt;
    &lt;<span style="color: #ff1493;">population</span> <span style="color: #ff69b4;">id</span>=<span style="color: #61CE3C;">"X"</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"RealParameter"</span> <span style="color: #ff69b4;">value</span>=<span style="color: #61CE3C;">"1"</span>/&gt;
    &lt;<span style="color: #ff1493;">samplePopulation</span> <span style="color: #ff69b4;">id</span>=<span style="color: #61CE3C;">"samp"</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"RealParameter"</span> <span style="color: #ff69b4;">value</span>=<span style="color: #61CE3C;">"0"</span>/&gt;

    &lt;<span style="color: #ff1493;">reaction</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"Reaction"</span> <span style="color: #ff69b4;">rate</span>=<span style="color: #61CE3C;">"1.4"</span>&gt; X -&gt; 2X &lt;/<span style="color: #ff1493;">reaction</span>&gt;
    &lt;<span style="color: #ff1493;">reaction</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"Reaction"</span> <span style="color: #ff69b4;">rate</span>=<span style="color: #61CE3C;">"0.5"</span>&gt; X -&gt; 0 &lt;/<span style="color: #ff1493;">reaction</span>&gt;
    &lt;<span style="color: #ff1493;">reaction</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"Reaction"</span> <span style="color: #ff69b4;">rate</span>=<span style="color: #61CE3C;">"0.5"</span>&gt; X -&gt; samp &lt;/<span style="color: #ff1493;">reaction</span>&gt;
  &lt;/<span style="color: #ff1493;">trajectory</span>&gt;
&lt;/<span style="color: #ff1493;">tree</span>&gt;
</pre>
</div>

<p>
Besides <code>trajectory</code>, <code>SimulatedTree</code> takes one optional input: <code>maxRetries</code>.  This is
the maximum number of times the simulator should attempt to produce a tree, in the
event that the first simulated tree does not have exactly one root lineage.
(Simulated trees may have more than one root lineage in the instance that not
all sampled lineages find a common ancestor before the start of the simulation;
a situation common for deterministic trajectories. It can also occur when the initial
number of individuals in the sampled population is greater than 1.)
</p>
</div>

<div id="outline-container-orgb8d3d86" class="outline-3">
<h3 id="orgb8d3d86"><span class="section-number-3">5.1.</span> Self-contained tree simulation XMLs</h3>
<div class="outline-text-3" id="text-5-1">
<p>
A self-contained tree simulation XML is very similar to a self-contained trajectory
simulation XML.  The only differences are that tree simulation XMLs have a <code>SimulatedTree</code>
object for the <code>&lt;simulate&gt;</code> element, and generally have a logger which writes the
simulated trees to a file.
</p>

<p>
For example, here is a full XML description of a tree simulator which produces
trees sampled from a linear birth-death-sampling model and saves them to a file
named "output.trees":
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #ff1493;">beast</span> <span style="color: #ff69b4;">version</span>=<span style="color: #61CE3C;">"2.0"</span> <span style="color: #ff69b4;">namespace</span>=<span style="color: #61CE3C;">"beast.core.parameter:remaster"</span>&gt;
  &lt;<span style="color: #ff1493;">run</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"Simulator"</span> <span style="color: #ff69b4;">nSims</span>=<span style="color: #61CE3C;">"1"</span>&gt;
    &lt;<span style="color: #ff1493;">simulate</span> <span style="color: #ff69b4;">id</span>=<span style="color: #61CE3C;">"tree"</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"SimulatedTree"</span>&gt;
      &lt;<span style="color: #ff1493;">trajectory</span> <span style="color: #ff69b4;">id</span>=<span style="color: #61CE3C;">"trajectory"</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"StochasticTrajectory"</span> <span style="color: #ff69b4;">maxTime</span>=<span style="color: #61CE3C;">"10"</span>&gt;
        &lt;<span style="color: #ff1493;">population</span> <span style="color: #ff69b4;">id</span>=<span style="color: #61CE3C;">"X"</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"RealParameter"</span> <span style="color: #ff69b4;">value</span>=<span style="color: #61CE3C;">"1"</span>/&gt;
        &lt;<span style="color: #ff1493;">samplePopulation</span> <span style="color: #ff69b4;">id</span>=<span style="color: #61CE3C;">"samp"</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"RealParameter"</span> <span style="color: #ff69b4;">value</span>=<span style="color: #61CE3C;">"0"</span>/&gt;

        &lt;<span style="color: #ff1493;">reaction</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"Reaction"</span> <span style="color: #ff69b4;">rate</span>=<span style="color: #61CE3C;">"1.4"</span>&gt; X -&gt; 2X &lt;/<span style="color: #ff1493;">reaction</span>&gt;
        &lt;<span style="color: #ff1493;">reaction</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"Reaction"</span> <span style="color: #ff69b4;">rate</span>=<span style="color: #61CE3C;">"0.5"</span>&gt; X -&gt; 0 &lt;/<span style="color: #ff1493;">reaction</span>&gt;
        &lt;<span style="color: #ff1493;">reaction</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"Reaction"</span> <span style="color: #ff69b4;">rate</span>=<span style="color: #61CE3C;">"0.5"</span>&gt; X -&gt; samp &lt;/<span style="color: #ff1493;">reaction</span>&gt;
      &lt;/<span style="color: #ff1493;">trajectory</span>&gt;
    &lt;/<span style="color: #ff1493;">simulate</span>&gt;

    &lt;<span style="color: #ff1493;">logger</span> <span style="color: #ff69b4;">fileName</span>=<span style="color: #61CE3C;">"output.traj"</span>&gt;
      &lt;<span style="color: #ff1493;">log</span> <span style="color: #ff69b4;">idref</span>=<span style="color: #61CE3C;">"trajectory"</span>/&gt;
    &lt;/<span style="color: #ff1493;">logger</span>&gt;

    &lt;<span style="color: #ff1493;">logger</span> <span style="color: #ff69b4;">fileName</span>=<span style="color: #61CE3C;">"output.trees"</span>&gt;
      &lt;<span style="color: #ff1493;">log</span> <span style="color: #ff69b4;">idref</span>=<span style="color: #61CE3C;">"tree"</span>/&gt;
    &lt;/<span style="color: #ff1493;">logger</span>&gt;
  &lt;/<span style="color: #ff1493;">run</span>&gt;
&lt;/<span style="color: #ff1493;">beast</span>&gt;
</pre>
</div>

<p>
Note that in this example we have left the trajectory logger in place,
so in fact this XML produces both <code>output.traj</code> and <code>output.tree</code>
files.
</p>

<p>
Loading the tree file in a phylogenetic tree viewer such as <a href="https://icytree.org">icytree</a> allows you
to view the result:
</p>


<figure id="org48a564d">
<img src="examples/BDtree_output.png" alt="BDtree_output.png">

</figure>
</div>
</div>

<div id="outline-container-org7ce50a0" class="outline-3">
<h3 id="org7ce50a0"><span class="section-number-3">5.2.</span> Logging typed trees</h3>
<div class="outline-text-3" id="text-5-2">
<p>
The example model in the previous section contained only one main population
type (besides the sample population).  However, many interesting models
involve multiple types and result in trees whose edges are associated with
different populations.  The standard BEAST tree logger used in the previous
example will not record this information in its output file.
</p>

<p>
In order to include this information so that it can be shown on the tree,
you'll need to use the <code>TypedTreeLogger</code> in place of the standard logger:
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #ff1493;">beast</span> <span style="color: #ff69b4;">version</span>=<span style="color: #61CE3C;">"2.0"</span> <span style="color: #ff69b4;">namespace</span>=<span style="color: #61CE3C;">"beast.core.parameter:remaster"</span>&gt;
  &lt;<span style="color: #ff1493;">run</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"Simulator"</span> <span style="color: #ff69b4;">nSims</span>=<span style="color: #61CE3C;">"1"</span>&gt;
    &lt;<span style="color: #ff1493;">simulate</span> <span style="color: #ff69b4;">id</span>=<span style="color: #61CE3C;">"tree"</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"SimulatedTree"</span>&gt;
      &lt;<span style="color: #ff1493;">trajectory</span> <span style="color: #ff69b4;">id</span>=<span style="color: #61CE3C;">"trajectory"</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"StochasticTrajectory"</span> <span style="color: #ff69b4;">maxTime</span>=<span style="color: #61CE3C;">"10"</span>&gt;
        &lt;<span style="color: #ff1493;">population</span> <span style="color: #ff69b4;">id</span>=<span style="color: #61CE3C;">"X"</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"RealParameter"</span> <span style="color: #ff69b4;">value</span>=<span style="color: #61CE3C;">"1"</span>/&gt;
        &lt;<span style="color: #ff1493;">population</span> <span style="color: #ff69b4;">id</span>=<span style="color: #61CE3C;">"Y"</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"RealParameter"</span> <span style="color: #ff69b4;">value</span>=<span style="color: #61CE3C;">"0"</span>/&gt;
        &lt;<span style="color: #ff1493;">samplePopulation</span> <span style="color: #ff69b4;">id</span>=<span style="color: #61CE3C;">"samp"</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"RealParameter"</span> <span style="color: #ff69b4;">value</span>=<span style="color: #61CE3C;">"0"</span>/&gt;

        &lt;<span style="color: #ff1493;">reaction</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"Reaction"</span> <span style="color: #ff69b4;">rate</span>=<span style="color: #61CE3C;">"1.4"</span>&gt; X -&gt; 2X &lt;/<span style="color: #ff1493;">reaction</span>&gt;
        &lt;<span style="color: #ff1493;">reaction</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"Reaction"</span> <span style="color: #ff69b4;">rate</span>=<span style="color: #61CE3C;">"0.1"</span>&gt; X -&gt; Y &lt;/<span style="color: #ff1493;">reaction</span>&gt;
        &lt;<span style="color: #ff1493;">reaction</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"Reaction"</span> <span style="color: #ff69b4;">rate</span>=<span style="color: #61CE3C;">"0.5"</span>&gt; X -&gt; 0 &lt;/<span style="color: #ff1493;">reaction</span>&gt;
        &lt;<span style="color: #ff1493;">reaction</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"Reaction"</span> <span style="color: #ff69b4;">rate</span>=<span style="color: #61CE3C;">"0.5"</span>&gt; Y -&gt; samp &lt;/<span style="color: #ff1493;">reaction</span>&gt;
      &lt;/<span style="color: #ff1493;">trajectory</span>&gt;
    &lt;/<span style="color: #ff1493;">simulate</span>&gt;

    &lt;<span style="color: #ff1493;">logger</span> <span style="color: #ff69b4;">fileName</span>=<span style="color: #61CE3C;">"output.trees"</span> <span style="color: #ff69b4;">mode</span>=<span style="color: #61CE3C;">"tree"</span>&gt;
      &lt;<span style="color: #ff1493;">log</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"TypedTreeLogger"</span> <span style="color: #ff69b4;">tree</span>=<span style="color: #61CE3C;">"@tree"</span>/&gt;
    &lt;/<span style="color: #ff1493;">logger</span>&gt;
  &lt;/<span style="color: #ff1493;">run</span>&gt;
&lt;/<span style="color: #ff1493;">beast</span>&gt;
</pre>
</div>

<p>
By loading the resulting tree file into <a href="https://icytree.org">icytree</a> and colouring the edges using
the "type" attribute produces a visualisation in which the tree edges are
labeled by their corresponding population types:
</p>


<figure id="orgdf69b5f">
<img src="examples/BD2type_output.png" alt="BD2type_output.png">

</figure>
</div>
</div>

<div id="outline-container-orgca654b9" class="outline-3">
<h3 id="orgca654b9"><span class="section-number-3">5.3.</span> Logging untyped trees</h3>
<div class="outline-text-3" id="text-5-3">
<p>
Occasionally you really <b>do</b> want to log trees without any additional
type annotation.  With single-population models this can be achieved
as shown in <a href="#orgb8d3d86">5.1</a>.  However,
multi-population models (or models with sub-populations) often produce
trees with internal nodes representing type changes.  These nodes will
appear in the output trees, even when the edge types are not recorded.
This can also produce problems when using ReMASTER <code>SimulatedTree</code> objects
to initialise standard BEAST MCMC analyses, as the extra nodes will not
be properly understood.
</p>

<p>
To avoid these problems, use <code>TypedTreeLogger</code> as in the previous
section, but add the attribute <code>removeSingletonNodes="true"</code>. This
will produce a tree in which the internal degree 3 nodes (one parent
two children) are still annotated, but in which degree 2 nodes (one
parent one child) are removed.  Such trees are fully compatable with
the rest of BEAST.
</p>
</div>
</div>
</div>

<div id="outline-container-orgcbe2b9b" class="outline-2">
<h2 id="orgcbe2b9b"><span class="section-number-2">6.</span> Integrating with BEAST</h2>
<div class="outline-text-2" id="text-6">
<p>
Unlike MASTER, ReMASTER is tightly integrated with the rest of BEAST in the following ways:
</p>

<ul class="org-ul">
<li>trees are standard BEAST <code>Tree</code> objects,</li>
<li>it uses standard <code>Logger</code> objects to produce output,</li>
<li>it uses <code>RealParameter</code> or <code>Function</code> objects to define populations,</li>
<li>the inputs defining reaction rates, times, probabilities or numbers
expect generic <code>Function</code> inputs.</li>
</ul>

<p>
This means that it is possible to use ReMASTER to initialise MCMC chains, to
simulate sequence data, or to produce single-XML simulation studies which combine
both simulation and inference.
</p>

<p>
Furthermore, the copious use of <code>Function</code> input types means that one can use
the <code>Function</code>-specific objects from the <a href="https://github.com/tgvaughan/feast">feast</a> package to create simulation XMLs
in which parameters are transformed in moderately complex ways before being
applied to the simulation.
</p>

<p>
For instance, suppose one wishes to simulate a tree under an epidemiological model
defined by a basic reproductive number $R=\lambda/\mu$ instead of a birth rate.
One can easily do this as follows:
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #ff1493;">beast</span> <span style="color: #ff69b4;">version</span>=<span style="color: #61CE3C;">"2.0"</span> <span style="color: #ff69b4;">namespace</span>=<span style="color: #61CE3C;">"beast.core.parameter:remaster"</span>&gt;
  &lt;<span style="color: #ff1493;">param</span> <span style="color: #ff69b4;">id</span>=<span style="color: #61CE3C;">"R"</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"RealParameter"</span> <span style="color: #ff69b4;">value</span>=<span style="color: #61CE3C;">"1.5"</span>/&gt;
  &lt;<span style="color: #ff1493;">param</span> <span style="color: #ff69b4;">id</span>=<span style="color: #61CE3C;">"mu"</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"RealParameter"</span> <span style="color: #ff69b4;">value</span>=<span style="color: #61CE3C;">"1.0"</span>/&gt;

  &lt;<span style="color: #ff1493;">param</span> <span style="color: #ff69b4;">id</span>=<span style="color: #61CE3C;">"lambda"</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"feast.expressions.ExpCalculator"</span> <span style="color: #ff69b4;">value</span>=<span style="color: #61CE3C;">"R*mu"</span>&gt;
    &lt;<span style="color: #ff1493;">arg</span> <span style="color: #ff69b4;">idref</span>=<span style="color: #61CE3C;">"R"</span>/&gt;
    &lt;<span style="color: #ff1493;">arg</span> <span style="color: #ff69b4;">idref</span>=<span style="color: #61CE3C;">"mu"</span>/&gt;
  &lt;/<span style="color: #ff1493;">param</span>&gt;

  &lt;<span style="color: #ff1493;">run</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"Simulator"</span> <span style="color: #ff69b4;">nSims</span>=<span style="color: #61CE3C;">"1"</span>&gt;
    &lt;<span style="color: #ff1493;">simulate</span> <span style="color: #ff69b4;">id</span>=<span style="color: #61CE3C;">"trajectory"</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"StochasticTrajectory"</span> <span style="color: #ff69b4;">maxTime</span>=<span style="color: #61CE3C;">"10"</span>&gt;
      &lt;<span style="color: #ff1493;">population</span> <span style="color: #ff69b4;">id</span>=<span style="color: #61CE3C;">"X"</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"RealParameter"</span> <span style="color: #ff69b4;">value</span>=<span style="color: #61CE3C;">"1"</span>/&gt;
      &lt;<span style="color: #ff1493;">reaction</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"Reaction"</span> <span style="color: #ff69b4;">rate</span>=<span style="color: #61CE3C;">"@lambda"</span>&gt; X -&gt; 2X &lt;/<span style="color: #ff1493;">reaction</span>&gt;
      &lt;<span style="color: #ff1493;">reaction</span> <span style="color: #ff69b4;">spec</span>=<span style="color: #61CE3C;">"Reaction"</span> <span style="color: #ff69b4;">rate</span>=<span style="color: #61CE3C;">"@mu"</span>&gt; X -&gt; 0 &lt;/<span style="color: #ff1493;">reaction</span>&gt;
    &lt;/<span style="color: #ff1493;">simulate</span>&gt;

    &lt;<span style="color: #ff1493;">logger</span> <span style="color: #ff69b4;">fileName</span>=<span style="color: #61CE3C;">"output.traj"</span>&gt;
      &lt;<span style="color: #ff1493;">log</span> <span style="color: #ff69b4;">idref</span>=<span style="color: #61CE3C;">"trajectory"</span>/&gt;
    &lt;/<span style="color: #ff1493;">logger</span>&gt;
  &lt;/<span style="color: #ff1493;">run</span>&gt;
&lt;/<span style="color: #ff1493;">beast</span>&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org068cfc9" class="outline-2">
<h2 id="org068cfc9"><span class="section-number-2">7.</span> Examples</h2>
<div class="outline-text-2" id="text-7">
<p>
The <code>examples/</code> directory of the package repository contains a growing list of example
ReMASTER scripts.  These are installed alongside the package when you install it via BEAUti.
You can also access these example scripts directly via the Github repository for the
package: <a href="https://github.com/tgvaughan/remaster/tree/master/examples">https://github.com/tgvaughan/remaster/tree/master/examples</a>.
</p>
</div>
</div>


<div id="outline-container-orgf953a7e" class="outline-2">
<h2 id="orgf953a7e"><span class="section-number-2">8.</span> Appendix</h2>
<div class="outline-text-2" id="text-8">
</div>
<div id="outline-container-org47608ae" class="outline-3">
<h3 id="org47608ae"><span class="section-number-3">8.1.</span> Condition syntax</h3>
<div class="outline-text-3" id="text-8-1">
<p>
The expressions provided to <code>endsWhen</code> and <code>mustHave</code> conform to the following
grammar:
</p>

<pre class="example" id="org6e07616">
expression :
  '(' expression ')'
  |   (SUM|MIN|MAX) '(' expression ')'
  |   expression ('*'|'/'|'%') expression
  |   expression ('+'|'-') expression
  |   expression ('=='|'!='|'&lt;'|'&gt;'|'&lt;='|'&gt;=') expression
  |   expression ('&amp;&amp;'|'||') expression
  |   POP_ID
  |   NUMBER
  ;
</pre>

<p>
Here SUM(), MIN() and MAX() are functions which take a population
vector and compute the sum, minimum, or maximum, respectively.
</p>

<p>
POP<sub>ID</sub> is any population ID such as "X" or "I[0]".
</p>

<p>
Beware when assembling these instructions that XML rules must be
obeyed.  In particular, you must use XML entities for characters such
as &amp; and &gt;, so that instead of writing <code>"X&gt;2 &amp;&amp; Y&gt;10"</code> you must
instead write <code>"X&amp;gt;2 &amp;amp;&amp;amp; Y&amp;gt;10"</code>.
</p>

<p>
Relevant characters and their corresponding XML entities are as follows
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Character</th>
<th scope="col" class="org-left">Entity</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">&gt;</td>
<td class="org-left">&amp;gt;</td>
</tr>

<tr>
<td class="org-left">&lt;</td>
<td class="org-left">&amp;lt;</td>
</tr>

<tr>
<td class="org-left">&amp;</td>
<td class="org-left">&amp;amp;</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Tim Vaughan</p>
<p class="date">Created: 2022-09-19 Mon 13:59</p>
</div>
</body>
</html>
